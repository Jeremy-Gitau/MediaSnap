name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  lint-and-format:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort
    
    - name: Format with black
      run: |
        black --check mediasnap/ app.py || echo "Code formatting issues found"
    
    - name: Lint with flake8
      run: |
        # Stop build if there are critical errors
        flake8 mediasnap/ app.py --count --select=E9,F63,F7,F82 --show-source --statistics
        # Allow warnings
        flake8 mediasnap/ app.py --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
    
    - name: Check import sorting
      run: |
        isort --check-only mediasnap/ app.py || echo "Import sorting issues found"

  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: lint-and-format
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller build_windows.spec
    
    - name: Test executable exists
      run: |
        if (Test-Path "dist/MediaSnap.exe") {
          Write-Host "✅ Executable built successfully"
          Get-Item dist/MediaSnap.exe
        } else {
          Write-Host "❌ Executable not found"
          exit 1
        }
    
    - name: Upload Windows Executable
      uses: actions/upload-artifact@v4
      with:
        name: MediaSnap-Windows
        path: dist/MediaSnap.exe
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/MediaSnap.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller build_linux.spec
    
    - name: Test executable exists
      run: |
        if [ -f "dist/MediaSnap" ]; then
          echo "✅ Executable built successfully"
          ls -lh dist/MediaSnap
          chmod +x dist/MediaSnap
        else
          echo "❌ Executable not found"
          exit 1
        fi
    
    - name: Upload Linux Executable
      uses: actions/upload-artifact@v4
      with:
        name: MediaSnap-Linux
        path: dist/MediaSnap
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/MediaSnap
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Application
    runs-on: macos-latest
    needs: lint-and-format
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller build_macos.spec
    
    - name: Test application bundle exists
      run: |
        if [ -d "dist/MediaSnap.app" ]; then
          echo "✅ Application bundle built successfully"
          ls -lh dist/MediaSnap.app/Contents/MacOS/
        else
          echo "❌ Application bundle not found"
          exit 1
        fi
    
    - name: Create DMG (optional)
      run: |
        # Create a simple zip for distribution
        cd dist
        zip -r MediaSnap-macOS.zip MediaSnap.app
        cd ..
    
    - name: Upload macOS Application
      uses: actions/upload-artifact@v4
      with:
        name: MediaSnap-macOS
        path: dist/MediaSnap-macOS.zip
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/MediaSnap-macOS.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
    
    - name: Run basic import test
      run: |
        python -c "from mediasnap.core.app_service import MediaSnapService; print('✅ Imports successful')"
    
    - name: Check structure
      run: |
        python -c "
        import os
        required = ['mediasnap/', 'app.py', 'requirements.txt']
        for item in required:
            if os.path.exists(item):
                print(f'✅ {item} found')
            else:
                print(f'❌ {item} missing')
                exit(1)
        "
